networks:
  default:

services:
  orchestrator:
    container_name: "orama-orchestrator-${ENVIRONMENT}"
    build: 
      context: ./orchestrator
      dockerfile: Dockerfile
    image: oramaframework/orchestrator-${ENVIRONMENT}
    restart: always
    ports:
      - "${ORCHESTRATOR_PORT}:3200"
    volumes:
      - .${GCP_JSON_FILE}:${GCP_JSON_FILE}
      - ./use-cases:/use-cases
      - ./data/logs/provisions:/logs
      - ./data/provisions:/provisions
      - /usr/logs/orchestrator:/tmp/logs
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - REACT_APP_PORT=3200
      - REACT_APP_BACKEND_URL=${BACKEND_URL}
      - REACT_APP_BENCHMARKER_URL=${BENCHMARKER_URL}
      - REACT_APP_ORCHESTRATOR_URL=${ORCHESTRATOR_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - GCP_JSON_FILE=${GCP_JSON_FILE}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - AZURE_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - ALICLOUD_ACCESS_KEY=${ALICLOUD_ACCESS_KEY}
      - ALICLOUD_SECRET_KEY=${ALICLOUD_SECRET_KEY}

  benchmarker:
    container_name: "orama-benchmarker-${ENVIRONMENT}"
    build: 
      context: ./benchmarker
      dockerfile: Dockerfile
    image: oramaframework/benchmarker-${ENVIRONMENT}
    restart: always
    ports:
      - "${BENCHMARKER_PORT}:3100"
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - REACT_APP_PORT=3100
      - REACT_APP_BACKEND_URL=${BACKEND_URL}
      - REACT_APP_BENCHMARKER_URL=${BENCHMARKER_URL}
      - REACT_APP_ORCHESTRATOR_URL=${ORCHESTRATOR_URL}
    volumes:
      - ./data/csvs:/csvs
      - ./data/reports:/reports
      - ./data/benchmarker:/results
      - ./benchmarker/plugins:/plugins
      - /usr/logs/benchmarker:/tmp/logs

  frontend:
    container_name: "orama-frontend-${ENVIRONMENT}"
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    image: oramaframework/frontend-${ENVIRONMENT}
    restart: always
    ports:
      - "${FRONTEND_PORT}:3000"
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - REACT_APP_PORT=3000
      - REACT_APP_BACKEND_URL=${BACKEND_URL}
      - REACT_APP_BENCHMARKER_URL=${BENCHMARKER_URL}
      - REACT_APP_ORCHESTRATOR_URL=${ORCHESTRATOR_URL}
      - REACT_APP_HALSTEADER_URL=${HALSTEADER_URL}
      - REACT_APP_PREDICTOR_URL=${PREDICTOR_URL}
      
  backend:
    container_name: "orama-backend-${ENVIRONMENT}"
    build: 
      context: ./backend
      dockerfile: Dockerfile
    image: oramaframework/backend-${ENVIRONMENT}
    restart: always
    ports:
      - "${BACKEND_PORT}:3001"
    environment:
      - HOST=${HOSTNAME}
      - ENVIRONMENT=${ENVIRONMENT}
      - PORT=3001
      - DB_CLIENT=pg
      - KAFKA_URL=kafka:9092
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - DB_PORT=${DATABASE_PORT}
      - DB_HOST=${DATABASE_HOST}
      - REACT_APP_PORT=3001
      - REACT_APP_BACKEND_URL=${BACKEND_URL}
      - REACT_APP_BENCHMARKER_URL=${BENCHMARKER_URL}
      - REACT_APP_ORCHESTRATOR_URL=${ORCHESTRATOR_URL}
    volumes:
      - ./data/csvs:/csvs
      - ./data/jsons:/jsons
      - /usr/logs/backend:/tmp/logs
    links: 
        - database
    networks:
      default:
    depends_on:
      kafka:
        condition: service_healthy

        
  database:
    image: postgres:13-alpine
    container_name: "orama-database-${ENVIRONMENT}"
    restart: always
    ports:
      - "${DATABASE_PORT}:5432" 
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./data/database:/var/lib/postgresql/data
    networks:
      default:
  kafka:
     image: apache/kafka:3.7.0
     container_name: "orama-kafka-${ENVIRONMENT}"
     restart: always
     ports:
       - "${KAFKA_BROKER_PORT}:9092"
       - "${KAFKA_CONTROLLER_PORT}:9093"
     volumes:
       - kafka_data:/tmp/kraft-combined-logs
     environment:
       KAFKA_PROCESS_ROLES: broker,controller
       KAFKA_NODE_ID: 1
       KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
       KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${KAFKA_HOST}:9092
       KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
       KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
       KAFKA_CONTROLLER_QUORUM_VOTERS: 1@${KAFKA_HOST}:9093
       KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
       KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
       KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
       KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
     networks:
       default:
     healthcheck:
       test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
       interval: 10s
       timeout: 10s
       retries: 5
       start_period: 30s
      
  benchmarker-worker:
    build: 
      context: ./benchmarker_worker
      dockerfile: Dockerfile
    image: oramaframework/benchmarker-worker
    restart: always
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - WORKER_NAME=${WORKER_NAME}
      - BACKEND_URL=${BACKEND_URL}
      - KAFKA_URL=${KAFKA_URL}
    depends_on:
      kafka:
        condition: service_healthy
        
  predictor:
    container_name: "orama-predictor-${ENVIRONMENT}"
    volumes:
       - "./predictor/model:/model"
       - "./predictor/dataset:/dataset"
    ports:
      - "${PREDICTOR_PORT}:5000"
    build: 
      context: ./predictor
      dockerfile: Dockerfile
    image: oramaframework/predictor
    restart: always
    environment:
      - PYTHONUNBUFFERED=1
  halsteader:
    container_name: "orama-halsteader-${ENVIRONMENT}"
    ports:
      - "5001:3000"
    build: 
      context: ./halsteader
      dockerfile: Dockerfile
    image: oramaframework/halsteader
    restart: always
volumes:
  kafka_data:
     driver: local
